var TAFFY,exports,T;
(function(){var x,D,u,y,z,h,E,d,q,A,v,p,t,B,l,F,C,G;if(!TAFFY)for(z=1,h={},E=function(a){return TAFFY.isArray(a)||TAFFY.isObject(a)?a:JSON.parse(a)},G=function(a){return"[object RegExp]"===Object.prototype.toString.call(a)},C=function(a){var b=T.isArray(a)?[]:T.isObject(a)?{}:null;if(null===a)return a;for(var c in a)b[c]=G(a[c])?a[c].toString():T.isArray(a[c])||T.isObject(a[c])?C(a[c]):a[c];return b},F=function(a){var b=JSON.stringify(a);return null===b.match(/regex/)?b:JSON.stringify(C(a))},d=function(a,
b,c){var f,e,g,r;if(a&&(T.isArray(a)&&1===a.length||!T.isArray(a)))b(T.isArray(a)?a[0]:a,0);else for(f,e,g=0,a=T.isArray(a)?a:[a],r=a.length;g<r;g++)if(e=a[g],!T.isUndefined(e)||c)if(f=b(e,g),f===T.EXIT)break},q=function(a,b){var c=0,f,e;for(e in a)if(a.hasOwnProperty(e)&&(f=b(a[e],e,c++),f===T.EXIT))break},h.extend=function(a,b){h[a]=function(){return b.apply(this,arguments)}},A=function(a){var b;return T.isString(a)&&/[t][0-9]*[r][0-9]*/i.test(a)||T.isObject(a)&&a.___id&&a.___s?!0:T.isArray(a)?
(b=!0,d(a,function(a){if(!A(a))return b=!1,TAFFY.EXIT}),b):!1},p=function(a,b){var c=!0;d(b,function(b){switch(T.typeOf(b)){case "function":if(!b.apply(a))return c=!1,TAFFY.EXIT;break;case "array":c=1===b.length?p(a,b[0]):2===b.length?p(a,b[0])||p(a,b[1]):3===b.length?p(a,b[0])||p(a,b[1])||p(a,b[2]):4===b.length?p(a,b[0])||p(a,b[1])||p(a,b[2])||p(a,b[3]):!1,4<b.length&&d(b,function(b){p(a,b)&&(c=!0)})}});return c},v=function(a){var b=[];T.isString(a)&&/[t][0-9]*[r][0-9]*/i.test(a)&&(a={___id:a});
if(T.isArray(a))return d(a,function(a){b.push(v(a))}),function(){var a=this,f=!1;d(b,function(b){p(a,b)&&(f=!0)});return f};if(T.isObject(a))return T.isObject(a)&&a.___id&&a.___s&&(a={___id:a.___id}),q(a,function(a,f){T.isObject(a)||(a={is:a});q(a,function(a,c){var r=[];("hasAll"===c?function(a,b){b(a)}:d)(a,function(a){var b=!0;r.push(function(){var e=this[f];if("undefined"===typeof e)return!1;0===c.indexOf("!")&&"!="!==c&&"!=="!==c&&(b=!1,c=c.substring(1,c.length));return e=(e="regex"===c?a.test(e):
"lt"===c||"<"===c?e<a:"gt"===c||">"===c?e>a:"lte"===c||"<="===c?e<=a:"gte"===c||">="===c?e>=a:"left"===c?0===e.indexOf(a):"leftnocase"===c?0===e.toLowerCase().indexOf(a.toLowerCase()):"right"===c?e.substring(e.length-a.length)===a:"rightnocase"===c?e.toLowerCase().substring(e.length-a.length)===a.toLowerCase():"like"===c?0<=e.indexOf(a):"likenocase"===c?0<=e.toLowerCase().indexOf(a.toLowerCase()):"==="===c||"is"===c?e===a:"=="===c?e==a:"!=="===c?e!==a:"!="===c?e!=a:"isnocase"===c?e.toLowerCase?e.toLowerCase()===
a.toLowerCase():e===a:"has"===c?T.has(e,a):"hasall"===c?T.hasAll(e,a):"contains"===c?TAFFY.isArray(e)&&-1<e.indexOf(a):-1!==c.indexOf("is")||TAFFY.isNull(e)||TAFFY.isUndefined(e)||TAFFY.isObject(a)||TAFFY.isArray(a)?T[c]&&T.isFunction(T[c])&&0===c.indexOf("is")?T[c](e)===a:T[c]&&T.isFunction(T[c])?T[c](e,a):!1:a===e[c])&&!b?!1:e||b?e:!0})});1===r.length?b.push(r[0]):b.push(function(){var a=this,b=!1;d(r,function(c){c.apply(a)&&(b=!0)});return b})})}),function(){var a=this,f=!0,f=1!==b.length||b[0].apply(a)?
2!==b.length||b[0].apply(a)&&b[1].apply(a)?3!==b.length||b[0].apply(a)&&b[1].apply(a)&&b[2].apply(a)?4!==b.length||b[0].apply(a)&&b[1].apply(a)&&b[2].apply(a)&&b[3].apply(a)?!0:!1:!1:!1:!1;4<b.length&&d(b,function(b){p(a,b)||(f=!1)});return f};if(T.isFunction(a))return a},B=function(a,b){var c=function(a,c){var g=0;T.each(b,function(b){var d,k,m;d=b.split(" ");b=d[0];d=1===d.length?"logical":d[1];if("logical"===d)k=t(a[b]),m=t(c[b]),T.each(k.length<=m.length?k:m,function(a,b){if(k[b]<m[b])return g=
-1,TAFFY.EXIT;if(k[b]>m[b])return g=1,TAFFY.EXIT});else if("logicaldesc"===d)k=t(a[b]),m=t(c[b]),T.each(k.length<=m.length?k:m,function(a,b){if(k[b]>m[b])return g=-1,TAFFY.EXIT;if(k[b]<m[b])return g=1,TAFFY.EXIT});else{if("asec"===d&&a[b]<c[b])return g=-1,T.EXIT;if("asec"===d&&a[b]>c[b])return g=1,T.EXIT;if("desc"===d&&a[b]>c[b])return g=-1,T.EXIT;if("desc"===d&&a[b]<c[b])return g=1,T.EXIT}0===g&&"logical"===d&&k.length<m.length?g=-1:0===g&&"logical"===d&&k.length>m.length?g=1:0===g&&"logicaldesc"===
d&&k.length>m.length?g=-1:0===g&&"logicaldesc"===d&&k.length<m.length&&(g=1);if(0!==g)return T.EXIT});return g};return a&&a.push?a.sort(c):a},function(){var a={},b=0;t=function(c){1E3<b&&(a={},b=0);var f;if(!(f=a["_"+c])){f=String(c);var e=[],g="_",d="",h,k,m;h=0;for(k=f.length;h<k;h++)m=f.charCodeAt(h),48<=m&&57>=m||46===m?"n"!==d&&(d="n",e.push(g.toLowerCase()),g=""):"s"!==d&&(d="s",e.push(parseFloat(g)),g=""),g+=f.charAt(h);e.push("n"===d?parseFloat(g):g.toLowerCase());e.shift();a["_"+c]=e;b++;
f=e}return f}}(),l=function(){this.context({results:this.getDBI().query(this.context())})},h.extend("filter",function(){var a=TAFFY.mergeObj(this.context(),{run:null}),b=[];d(a.q,function(a){b.push(a)});a.q=b;d(arguments,function(b){a.q.push(v(b));a.filterRaw.push(b)});return this.getroot(a)}),h.extend("order",function(a){a=a.split(",");var b=[];d(a,function(a){b.push(a.replace(/^\s*/,"").replace(/\s*$/,""))});a=TAFFY.mergeObj(this.context(),{sort:null});a.order=b;return this.getroot(a)}),h.extend("limit",
function(a){var b=TAFFY.mergeObj(this.context(),{}),c;b.limit=a;b.run&&b.sort&&(c=[],d(b.results,function(b,e){if(e+1>a)return TAFFY.EXIT;c.push(b)}),b.results=c);return this.getroot(b)}),h.extend("start",function(a){var b=TAFFY.mergeObj(this.context(),{}),c;b.start=a;b.run&&b.sort&&!b.limit?(c=[],d(b.results,function(b,e){e+1>a&&c.push(b)}),b.results=c):b=TAFFY.mergeObj(this.context(),{run:null,start:a});return this.getroot(b)}),h.extend("update",function(a,b,c){var f=!0,e={},g=arguments,r;!TAFFY.isString(a)||
2!==arguments.length&&3!==arguments.length?(e=a,2===g.length&&(f=b)):(e[a]=b,3===arguments.length&&(f=c));r=this;l.call(this);d(this.context().results,function(a){var b=e;TAFFY.isFunction(b)?b=b.apply(TAFFY.mergeObj(a,{})):T.isFunction(b)&&(b=b(TAFFY.mergeObj(a,{})));TAFFY.isObject(b)&&r.getDBI().update(a.___id,b,f)});this.context().results.length&&this.context({run:null});return this}),h.extend("remove",function(a){var b=this,c=0;l.call(this);d(this.context().results,function(a){b.getDBI().remove(a.___id);
c++});this.context().results.length&&(this.context({run:null}),b.getDBI().removeCommit(a));return c}),h.extend("count",function(){l.call(this);return this.context().results.length}),h.extend("callback",function(a,b){if(a){var c=this;setTimeout(function(){l.call(c);a.call(c.getroot(c.context()))},b||0)}return null}),h.extend("get",function(){l.call(this);return this.context().results}),h.extend("stringify",function(){return JSON.stringify(this.get())}),h.extend("first",function(){l.call(this);return this.context().results[0]||
!1}),h.extend("last",function(){l.call(this);return this.context().results[this.context().results.length-1]||!1}),h.extend("sum",function(){var a=0,b=this;l.call(b);d(arguments,function(c){d(b.context().results,function(b){a+=b[c]||0})});return a}),h.extend("min",function(a){var b=null;l.call(this);d(this.context().results,function(c){if(null===b||c[a]<b)b=c[a]});return b}),function(){var a=function(){var a,c;a=function(a,b,c){var d;2===c.length?(a=a[c[0]],d="===",b=b[c[1]]):(a=a[c[0]],d=c[1],b=b[c[2]]);
switch(d){case "===":return a===b;case "!==":return a!==b;case "<":return a<b;case ">":return a>b;case "<=":return a<=b;case ">=":return a>=b;case "==":return a==b;case "!=":return a!=b;default:throw String(d)+" is not supported";}};c=function(a,b){var c={},d,h;for(d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);for(d in b)b.hasOwnProperty(d)&&"___id"!==d&&"___s"!==d&&(h=TAFFY.isUndefined(c[d])?"":"right_",c[h+String(d)]=b[d]);return c};return function(d){var e,g,h=arguments,l=h.length,k=[];if("function"!==
typeof d.filter)if(d.TAFFY)e=d();else throw"TAFFY DB or result not supplied";else e=d;this.context({results:this.getDBI().query(this.context())});TAFFY.each(this.context().results,function(d){e.each(function(e){var f;f=!0;g=1;a:for(;g<l;g++)if(f=h[g],f="function"===typeof f?f(d,e):"object"===typeof f&&f.length?a(d,e,f):!1,!f)break a;f&&k.push(c(d,e))})});return TAFFY(k)()}}();h.extend("join",a)}(),h.extend("max",function(a){var b=null;l.call(this);d(this.context().results,function(c){if(null===b||
c[a]>b)b=c[a]});return b}),h.extend("select",function(){var a=[],b=arguments;l.call(this);1===arguments.length?d(this.context().results,function(c){a.push(c[b[0]])}):d(this.context().results,function(c){var f=[];d(b,function(a){f.push(c[a])});a.push(f)});return a}),h.extend("distinct",function(){var a=[],b=arguments;l.call(this);1===arguments.length?d(this.context().results,function(c){var f=c[b[0]],e=!1;d(a,function(a){if(f===a)return e=!0,TAFFY.EXIT});e||a.push(f)}):d(this.context().results,function(c){var f=
[],e=!1;d(b,function(a){f.push(c[a])});d(a,function(a){var c=!0;d(b,function(b,e){if(f[e]!==a[e])return c=!1,TAFFY.EXIT});if(c)return e=!0,TAFFY.EXIT});e||a.push(f)});return a}),h.extend("supplant",function(a,b){var c=[];l.call(this);d(this.context().results,function(b){c.push(a.replace(/\{([^\{\}]*)\}/g,function(a,c){var d=b[c];return"string"===typeof d||"number"===typeof d?d:a}))});return b?c:c.join("")}),h.extend("each",function(a){l.call(this);d(this.context().results,a);return this}),h.extend("map",
function(a){var b=[];l.call(this);d(this.context().results,function(c){b.push(a(c))});return b}),TAFFY=T=function(a){var b=[],c={},f=1,e={template:!1,onInsert:!1,onUpdate:!1,onRemove:!1,onDBChange:!1,storageName:!1,forcePropertyCase:null,cacheSize:100,name:""},g=new Date,l=0,w=0,k={},m,t,n;t=function(a){var e=[],f=!1;if(0===a.length)return b;d(a,function(a){T.isString(a)&&/[t][0-9]*[r][0-9]*/i.test(a)&&b[c[a]]&&(e.push(b[c[a]]),f=!0);T.isObject(a)&&a.___id&&a.___s&&b[c[a.___id]]&&(e.push(b[c[a.___id]]),
f=!0);T.isArray(a)&&d(a,function(a){d(t(a),function(a){e.push(a)})})});f&&1<e.length&&(e=[]);return e};m={dm:function(a){a&&(g=a,k={},w=l=0);e.onDBChange&&setTimeout(function(){e.onDBChange.call(b)},0);e.storageName&&setTimeout(function(){localStorage.setItem("taffy_"+e.storageName,JSON.stringify(b))});return g},insert:function(a,g){var h=[],k=[],l=E(a);d(l,function(a,H){var l,n;if(T.isArray(a)&&0===H)return d(a,function(a){h.push("lower"===e.forcePropertyCase?a.toLowerCase():"upper"===e.forcePropertyCase?
a.toUpperCase():a)}),!0;T.isArray(a)?(l={},d(a,function(a,b){l[h[b]]=a}),a=l):T.isObject(a)&&e.forcePropertyCase&&(n={},q(a,function(b,c){n["lower"===e.forcePropertyCase?c.toLowerCase():"upper"===e.forcePropertyCase?c.toUpperCase():c]=a[c]}),a=n);f++;a.___id||(a.___id="T"+String("000000"+z).slice(-6)+"R"+String("000000"+f).slice(-6));a.___s=!0;k.push(a.___id);e.template&&(a=T.mergeObj(e.template,a));b.push(a);c[a.___id]=b.length-1;e.onInsert&&(g||TAFFY.isUndefined(g))&&e.onInsert.call(a);m.dm(new Date)});
return n(k)},sort:function(a){b=B(b,a.split(","));c={};d(b,function(a,b){c[a.___id]=b});m.dm(new Date);return!0},update:function(a,d,f){var g={},h,k,l;e.forcePropertyCase&&(q(d,function(a,b){g["lower"===e.forcePropertyCase?b.toLowerCase():"upper"===e.forcePropertyCase?b.toUpperCase():b]=a}),d=g);h=b[c[a]];d=T.mergeObj(h,d);k={};l=!1;q(d,function(a,b){if(TAFFY.isUndefined(h[b])||h[b]!==a)k[b]=a,l=!0});l&&(e.onUpdate&&(f||TAFFY.isUndefined(f))&&e.onUpdate.call(d,b[c[a]],k),b[c[a]]=d,m.dm(new Date))},
remove:function(a){b[c[a]].___s=!1},removeCommit:function(a){var f;for(f=b.length-1;-1<f;f--)b[f].___s||(e.onRemove&&(a||TAFFY.isUndefined(a))&&e.onRemove.call(b[f]),c[b[f].___id]=void 0,b.splice(f,1));c={};d(b,function(a,b){c[a.___id]=b});m.dm(new Date)},query:function(a){var c,f,g,h,n;e.cacheSize&&(f="",d(a.filterRaw,function(a){if(T.isFunction(a))return f="nocache",TAFFY.EXIT}),""===f&&(f=F(T.mergeObj(a,{q:!1,run:!1,sort:!1}))));if(!a.results||!a.run||a.run&&m.dm()>a.run){g=[];if(e.cacheSize&&
k[f])return k[f].i=l++,k[f].results;0===a.q.length&&0===a.index.length?d(b,function(a){g.push(a)}):(c=t(a.index),d(c,function(b){(0===a.q.length||p(b,a.q))&&g.push(b)}));c=g}else c=a.results;!(0<a.order.length)||a.run&&a.sort||(c=B(c,a.order));c.length&&(a.limit&&a.limit<c.length||a.start)&&(h=[],d(c,function(b,c){if(!a.start||a.start&&c+1>=a.start)if(a.limit)if(n=a.start?c+1-a.start:c,n<a.limit)h.push(b);else{if(n>a.limit)return TAFFY.EXIT}else h.push(b)}),c=h);e.cacheSize&&"nocache"!==f&&(w++,setTimeout(function(){var a,
b;w>=2*e.cacheSize&&(w=0,a=l-e.cacheSize,b={},q(function(c,e){c.i>=a&&(b[e]=c)}),k=b)},0),k[f]={i:l++,results:c});return c}};n=function(){var a,b;a=TAFFY.mergeObj(TAFFY.mergeObj(h,{insert:void 0}),{getDBI:function(){return m},getroot:function(a){return n.call(a)},context:function(a){a&&(b=TAFFY.mergeObj(b,a.hasOwnProperty("results")?TAFFY.mergeObj(a,{run:new Date,sort:new Date}):a));return b},extend:void 0});b=this&&this.q?this:{limit:!1,start:!1,q:[],filterRaw:[],index:[],order:[],results:!1,run:null,
sort:null,settings:e};d(arguments,function(a){A(a)?b.index.push(a):b.q.push(v(a));b.filterRaw.push(a)});return a};z++;a&&m.insert(a);n.insert=m.insert;n.merge=function(a,b,c){var e={},f=[],g={};c=c||!1;b=b||"id";d(a,function(a){var d;e[b]=a[b];f.push(a[b]);(d=n(e).first())?m.update(d.___id,a,c):m.insert(a,c)});g[b]=f;return n(g)};n.TAFFY=!0;n.sort=m.sort;n.settings=function(a){a&&(e=TAFFY.mergeObj(e,a),a.template&&n().update(a.template));return e};n.store=function(a){var c;localStorage&&(a&&((c=localStorage.getItem("taffy_"+
a))&&0<c.length&&n.insert(c),0<b.length&&setTimeout(function(){localStorage.setItem("taffy_"+e.storageName,JSON.stringify(b))})),n.settings({storageName:a}));return n};return n},T.each=d,T.eachin=q,T.extend=h.extend,TAFFY.EXIT="TAFFYEXIT",TAFFY.mergeObj=function(a,b){var c={};q(a,function(b,e){c[e]=a[e]});q(b,function(a,e){c[e]=b[e]});return c},TAFFY.has=function(a,b){var c=!1,f;if(a.TAFFY){if(c=a(b),0<c.length)return!0}else switch(T.typeOf(a)){case "object":if(T.isObject(b))q(b,function(e,d){if(!0===
c&&!T.isUndefined(a[d])&&a.hasOwnProperty(d))c=T.has(a[d],b[d]);else return c=!1,TAFFY.EXIT});else if(T.isArray(b))d(b,function(e,d){if(c=T.has(a,b[d]))return TAFFY.EXIT});else if(T.isString(b))if(TAFFY.isUndefined(a[b]))break;else return!0;return c;case "array":if(T.isObject(b))d(a,function(e,d){c=T.has(a[d],b);if(!0===c)return TAFFY.EXIT});else if(T.isArray(b))d(b,function(e,f){d(a,function(e,d){c=T.has(a[d],b[f]);if(!0===c)return TAFFY.EXIT});if(!0===c)return TAFFY.EXIT});else if(T.isString(b)||
T.isNumber(b))for(c=!1,f=0;f<a.length;f++)if(c=T.has(a[f],b))return!0;return c;case "string":if(T.isString(b)&&b===a)return!0;break;default:if(T.typeOf(a)===T.typeOf(b)&&a===b)return!0}return!1},TAFFY.hasAll=function(a,b){var c=TAFFY,f;return c.isArray(b)?(f=!0,d(b,function(b){f=c.has(a,b);if(!1===f)return TAFFY.EXIT}),f):c.has(a,b)},TAFFY.typeOf=function(a){var b=typeof a;"object"===b&&(a?"number"!==typeof a.length||a.propertyIsEnumerable("length")||(b="array"):b="null");return b},TAFFY.getObjectKeys=
function(a){var b=[];q(a,function(a,d){b.push(d)});b.sort();return b},TAFFY.isSameArray=function(a,b){return TAFFY.isArray(a)&&TAFFY.isArray(b)&&a.join(",")===b.join(",")?!0:!1},TAFFY.isSameObject=function(a,b){var c=TAFFY,d=!0;c.isObject(a)&&c.isObject(b)?c.isSameArray(c.getObjectKeys(a),c.getObjectKeys(b))?q(a,function(e,g){if(!(c.isObject(a[g])&&c.isObject(b[g])&&c.isSameObject(a[g],b[g])||c.isArray(a[g])&&c.isArray(b[g])&&c.isSameArray(a[g],b[g])||a[g]===b[g]))return d=!1,TAFFY.EXIT}):d=!1:d=
!1;return d},x="String Number Object Array Boolean Null Function Undefined".split(" "),D=function(a){return function(b){return TAFFY.typeOf(b)===a.toLowerCase()?!0:!1}},u=0;u<x.length;u++)y=x[u],TAFFY["is"+y]=D(y)})();"object"===typeof exports&&(exports.taffy=TAFFY);